<html>
<head>
<title>build_meta.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.ln { color: #606366; font-weight: normal; font-style: normal; }
.s0 { color: rgb(98,151,85); font-style: italic; }
.s1 { color: rgb(169,183,198); }
.s2 { color: rgb(204,120,50); }
.s3 { color: rgb(106,135,89); }
.s4 { color: rgb(128,128,128); }
.s5 { color: rgb(104,151,187); }
</style>
</head>
<BODY BGCOLOR="#2b2b2b">
<TABLE CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<TR><TD><CENTER>
<FONT FACE="Arial, Helvetica" COLOR="#000000">
build_meta.py</FONT>
</center></TD></TR></TABLE>
<pre>
<span class="s0">&quot;&quot;&quot;A PEP 517 interface to setuptools 
 
Previously, when a user or a command line tool (let's call it a &quot;frontend&quot;) 
needed to make a request of setuptools to take a certain action, for 
example, generating a list of installation requirements, the frontend would 
would call &quot;setup.py egg_info&quot; or &quot;setup.py bdist_wheel&quot; on the command line. 
 
PEP 517 defines a different method of interfacing with setuptools. Rather 
than calling &quot;setup.py&quot; directly, the frontend should: 
 
  1. Set the current directory to the directory with a setup.py file 
  2. Import this module into a safe python interpreter (one in which 
     setuptools can potentially set global variables or crash hard). 
  3. Call one of the functions defined in PEP 517. 
 
What each function does is defined in PEP 517. However, here is a &quot;casual&quot; 
definition of the functions (this definition should not be relied on for 
bug reports or API stability): 
 
  - `build_wheel`: build a wheel in the folder and return the basename 
  - `get_requires_for_build_wheel`: get the `setup_requires` to build 
  - `prepare_metadata_for_build_wheel`: get the `install_requires` 
  - `build_sdist`: build an sdist in the folder and return the basename 
  - `get_requires_for_build_sdist`: get the `setup_requires` to build 
 
Again, this is not a formal definition! Just a &quot;taste&quot; of the module. 
&quot;&quot;&quot;</span><span class="s1"> 
 
</span><span class="s2">import </span><span class="s1">os 
</span><span class="s2">import </span><span class="s1">sys 
</span><span class="s2">import </span><span class="s1">tokenize 
</span><span class="s2">import </span><span class="s1">shutil 
</span><span class="s2">import </span><span class="s1">contextlib 
 
</span><span class="s2">import </span><span class="s1">setuptools 
</span><span class="s2">import </span><span class="s1">distutils 
 
 
</span><span class="s2">class </span><span class="s1">SetupRequirementsError(BaseException): 
    </span><span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">specifiers): 
        self.specifiers = specifiers 
 
 
</span><span class="s2">class </span><span class="s1">Distribution(setuptools.dist.Distribution): 
    </span><span class="s2">def </span><span class="s1">fetch_build_eggs(self</span><span class="s2">, </span><span class="s1">specifiers): 
        </span><span class="s2">raise </span><span class="s1">SetupRequirementsError(specifiers) 
 
    @classmethod 
    @contextlib.contextmanager 
    </span><span class="s2">def </span><span class="s1">patch(cls): 
        </span><span class="s0">&quot;&quot;&quot; 
        Replace 
        distutils.dist.Distribution with this class 
        for the duration of this context. 
        &quot;&quot;&quot;</span><span class="s1"> 
        orig = distutils.core.Distribution 
        distutils.core.Distribution = cls 
        </span><span class="s2">try</span><span class="s1">: 
            </span><span class="s2">yield</span><span class="s1"> 
        </span><span class="s2">finally</span><span class="s1">: 
            distutils.core.Distribution = orig 
 
 
</span><span class="s2">def </span><span class="s1">_run_setup(setup_script=</span><span class="s3">'setup.py'</span><span class="s1">): 
    </span><span class="s4"># Note that we can reuse our build directory between calls</span><span class="s1"> 
    </span><span class="s4"># Correctness comes first, then optimization later</span><span class="s1"> 
    __file__ = setup_script 
    __name__ = </span><span class="s3">'__main__'</span><span class="s1"> 
    f = getattr(tokenize</span><span class="s2">, </span><span class="s3">'open'</span><span class="s2">, </span><span class="s1">open)(__file__) 
    code = f.read().replace(</span><span class="s3">'</span><span class="s2">\\</span><span class="s3">r</span><span class="s2">\\</span><span class="s3">n'</span><span class="s2">, </span><span class="s3">'</span><span class="s2">\\</span><span class="s3">n'</span><span class="s1">) 
    f.close() 
    exec(compile(code</span><span class="s2">, </span><span class="s1">__file__</span><span class="s2">, </span><span class="s3">'exec'</span><span class="s1">)</span><span class="s2">, </span><span class="s1">locals()) 
 
 
</span><span class="s2">def </span><span class="s1">_fix_config(config_settings): 
    config_settings = config_settings </span><span class="s2">or </span><span class="s1">{} 
    config_settings.setdefault(</span><span class="s3">'--global-option'</span><span class="s2">, </span><span class="s1">[]) 
    </span><span class="s2">return </span><span class="s1">config_settings 
 
 
</span><span class="s2">def </span><span class="s1">_get_build_requires(config_settings): 
    config_settings = _fix_config(config_settings) 
    requirements = [</span><span class="s3">'setuptools'</span><span class="s2">, </span><span class="s3">'wheel'</span><span class="s1">] 
 
    sys.argv = sys.argv[:</span><span class="s5">1</span><span class="s1">] + [</span><span class="s3">'egg_info'</span><span class="s1">] + \ 
        config_settings[</span><span class="s3">&quot;--global-option&quot;</span><span class="s1">] 
    </span><span class="s2">try</span><span class="s1">: 
        </span><span class="s2">with </span><span class="s1">Distribution.patch(): 
            _run_setup() 
    </span><span class="s2">except </span><span class="s1">SetupRequirementsError </span><span class="s2">as </span><span class="s1">e: 
        requirements += e.specifiers 
 
    </span><span class="s2">return </span><span class="s1">requirements 
 
 
</span><span class="s2">def </span><span class="s1">_get_immediate_subdirectories(a_dir): 
    </span><span class="s2">return </span><span class="s1">[name </span><span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">os.listdir(a_dir) 
            </span><span class="s2">if </span><span class="s1">os.path.isdir(os.path.join(a_dir</span><span class="s2">, </span><span class="s1">name))] 
 
 
</span><span class="s2">def </span><span class="s1">get_requires_for_build_wheel(config_settings=</span><span class="s2">None</span><span class="s1">): 
    config_settings = _fix_config(config_settings) 
    </span><span class="s2">return </span><span class="s1">_get_build_requires(config_settings) 
 
 
</span><span class="s2">def </span><span class="s1">get_requires_for_build_sdist(config_settings=</span><span class="s2">None</span><span class="s1">): 
    config_settings = _fix_config(config_settings) 
    </span><span class="s2">return </span><span class="s1">_get_build_requires(config_settings) 
 
 
</span><span class="s2">def </span><span class="s1">prepare_metadata_for_build_wheel(metadata_directory</span><span class="s2">, </span><span class="s1">config_settings=</span><span class="s2">None</span><span class="s1">): 
    sys.argv = sys.argv[:</span><span class="s5">1</span><span class="s1">] + [</span><span class="s3">'dist_info'</span><span class="s2">, </span><span class="s3">'--egg-base'</span><span class="s2">, </span><span class="s1">metadata_directory] 
    _run_setup() 
     
    dist_info_directory = metadata_directory 
    </span><span class="s2">while True</span><span class="s1">:     
        dist_infos = [f </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">os.listdir(dist_info_directory) 
                      </span><span class="s2">if </span><span class="s1">f.endswith(</span><span class="s3">'.dist-info'</span><span class="s1">)] 
 
        </span><span class="s2">if </span><span class="s1">len(dist_infos) == </span><span class="s5">0 </span><span class="s2">and </span><span class="s1">\ 
                len(_get_immediate_subdirectories(dist_info_directory)) == </span><span class="s5">1</span><span class="s1">: 
            dist_info_directory = os.path.join( 
                dist_info_directory</span><span class="s2">, </span><span class="s1">os.listdir(dist_info_directory)[</span><span class="s5">0</span><span class="s1">]) 
            </span><span class="s2">continue</span><span class="s1"> 
 
        </span><span class="s2">assert </span><span class="s1">len(dist_infos) == </span><span class="s5">1</span><span class="s1"> 
        </span><span class="s2">break</span><span class="s1"> 
 
    </span><span class="s4"># PEP 517 requires that the .dist-info directory be placed in the</span><span class="s1"> 
    </span><span class="s4"># metadata_directory. To comply, we MUST copy the directory to the root</span><span class="s1"> 
    </span><span class="s2">if </span><span class="s1">dist_info_directory != metadata_directory: 
        shutil.move( 
            os.path.join(dist_info_directory</span><span class="s2">, </span><span class="s1">dist_infos[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">,</span><span class="s1"> 
            metadata_directory) 
        shutil.rmtree(dist_info_directory</span><span class="s2">, </span><span class="s1">ignore_errors=</span><span class="s2">True</span><span class="s1">) 
 
    </span><span class="s2">return </span><span class="s1">dist_infos[</span><span class="s5">0</span><span class="s1">] 
 
 
</span><span class="s2">def </span><span class="s1">build_wheel(wheel_directory</span><span class="s2">, </span><span class="s1">config_settings=</span><span class="s2">None,</span><span class="s1"> 
                metadata_directory=</span><span class="s2">None</span><span class="s1">): 
    config_settings = _fix_config(config_settings) 
    wheel_directory = os.path.abspath(wheel_directory) 
    sys.argv = sys.argv[:</span><span class="s5">1</span><span class="s1">] + [</span><span class="s3">'bdist_wheel'</span><span class="s1">] + \ 
        config_settings[</span><span class="s3">&quot;--global-option&quot;</span><span class="s1">] 
    _run_setup() 
    </span><span class="s2">if </span><span class="s1">wheel_directory != </span><span class="s3">'dist'</span><span class="s1">: 
        shutil.rmtree(wheel_directory) 
        shutil.copytree(</span><span class="s3">'dist'</span><span class="s2">, </span><span class="s1">wheel_directory) 
 
    wheels = [f </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">os.listdir(wheel_directory) 
              </span><span class="s2">if </span><span class="s1">f.endswith(</span><span class="s3">'.whl'</span><span class="s1">)] 
 
    </span><span class="s2">assert </span><span class="s1">len(wheels) == </span><span class="s5">1</span><span class="s1"> 
    </span><span class="s2">return </span><span class="s1">wheels[</span><span class="s5">0</span><span class="s1">] 
 
 
</span><span class="s2">def </span><span class="s1">build_sdist(sdist_directory</span><span class="s2">, </span><span class="s1">config_settings=</span><span class="s2">None</span><span class="s1">): 
    config_settings = _fix_config(config_settings) 
    sdist_directory = os.path.abspath(sdist_directory) 
    sys.argv = sys.argv[:</span><span class="s5">1</span><span class="s1">] + [</span><span class="s3">'sdist'</span><span class="s1">] + \ 
        config_settings[</span><span class="s3">&quot;--global-option&quot;</span><span class="s1">] 
    _run_setup() 
    </span><span class="s2">if </span><span class="s1">sdist_directory != </span><span class="s3">'dist'</span><span class="s1">: 
        shutil.rmtree(sdist_directory) 
        shutil.copytree(</span><span class="s3">'dist'</span><span class="s2">, </span><span class="s1">sdist_directory) 
 
    sdists = [f </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">os.listdir(sdist_directory) 
              </span><span class="s2">if </span><span class="s1">f.endswith(</span><span class="s3">'.tar.gz'</span><span class="s1">)] 
 
    </span><span class="s2">assert </span><span class="s1">len(sdists) == </span><span class="s5">1</span><span class="s1"> 
    </span><span class="s2">return </span><span class="s1">sdists[</span><span class="s5">0</span><span class="s1">] 
</span></pre>
</body>
</html>