<html>
<head>
<title>download.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.ln { color: #606366; font-weight: normal; font-style: normal; }
.s0 { color: rgb(204,120,50); }
.s1 { color: rgb(169,183,198); }
.s2 { color: rgb(98,151,85); font-style: italic; }
.s3 { color: rgb(106,135,89); }
.s4 { color: rgb(104,151,187); }
.s5 { color: rgb(128,128,128); }
</style>
</head>
<BODY BGCOLOR="#2b2b2b">
<TABLE CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<TR><TD><CENTER>
<FONT FACE="Arial, Helvetica" COLOR="#000000">
download.py</FONT>
</center></TD></TR></TABLE>
<pre>
<span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">absolute_import 
 
</span><span class="s0">import </span><span class="s1">logging 
</span><span class="s0">import </span><span class="s1">os 
 
</span><span class="s0">from </span><span class="s1">pip.exceptions </span><span class="s0">import </span><span class="s1">CommandError 
</span><span class="s0">from </span><span class="s1">pip.index </span><span class="s0">import </span><span class="s1">FormatControl 
</span><span class="s0">from </span><span class="s1">pip.req </span><span class="s0">import </span><span class="s1">RequirementSet 
</span><span class="s0">from </span><span class="s1">pip.basecommand </span><span class="s0">import </span><span class="s1">RequirementCommand 
</span><span class="s0">from </span><span class="s1">pip </span><span class="s0">import </span><span class="s1">cmdoptions 
</span><span class="s0">from </span><span class="s1">pip.utils </span><span class="s0">import </span><span class="s1">ensure_dir</span><span class="s0">, </span><span class="s1">normalize_path 
</span><span class="s0">from </span><span class="s1">pip.utils.build </span><span class="s0">import </span><span class="s1">BuildDirectory 
</span><span class="s0">from </span><span class="s1">pip.utils.filesystem </span><span class="s0">import </span><span class="s1">check_path_owner 
 
 
logger = logging.getLogger(__name__) 
 
 
</span><span class="s0">class </span><span class="s1">DownloadCommand(RequirementCommand): 
    </span><span class="s2">&quot;&quot;&quot; 
    Download packages from: 
 
    - PyPI (and other indexes) using requirement specifiers. 
    - VCS project urls. 
    - Local project directories. 
    - Local or remote source archives. 
 
    pip also supports downloading from &quot;requirements files&quot;, which provide 
    an easy way to specify a whole environment to be downloaded. 
    &quot;&quot;&quot;</span><span class="s1"> 
    name = </span><span class="s3">'download'</span><span class="s1"> 
 
    usage = </span><span class="s3">&quot;&quot;&quot; 
      %prog [options] &lt;requirement specifier&gt; [package-index-options] ... 
      %prog [options] -r &lt;requirements file&gt; [package-index-options] ... 
      %prog [options] [-e] &lt;vcs project url&gt; ... 
      %prog [options] [-e] &lt;local project path&gt; ... 
      %prog [options] &lt;archive url/path&gt; ...&quot;&quot;&quot;</span><span class="s1"> 
 
    summary = </span><span class="s3">'Download packages.'</span><span class="s1"> 
 
    </span><span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kw): 
        super(DownloadCommand</span><span class="s0">, </span><span class="s1">self).__init__(*args</span><span class="s0">, </span><span class="s1">**kw) 
 
        cmd_opts = self.cmd_opts 
 
        cmd_opts.add_option(cmdoptions.constraints()) 
        cmd_opts.add_option(cmdoptions.editable()) 
        cmd_opts.add_option(cmdoptions.requirements()) 
        cmd_opts.add_option(cmdoptions.build_dir()) 
        cmd_opts.add_option(cmdoptions.no_deps()) 
        cmd_opts.add_option(cmdoptions.global_options()) 
        cmd_opts.add_option(cmdoptions.no_binary()) 
        cmd_opts.add_option(cmdoptions.only_binary()) 
        cmd_opts.add_option(cmdoptions.src()) 
        cmd_opts.add_option(cmdoptions.pre()) 
        cmd_opts.add_option(cmdoptions.no_clean()) 
        cmd_opts.add_option(cmdoptions.require_hashes()) 
 
        cmd_opts.add_option( 
            </span><span class="s3">'-d'</span><span class="s0">, </span><span class="s3">'--dest'</span><span class="s0">, </span><span class="s3">'--destination-dir'</span><span class="s0">, </span><span class="s3">'--destination-directory'</span><span class="s0">,</span><span class="s1"> 
            dest=</span><span class="s3">'download_dir'</span><span class="s0">,</span><span class="s1"> 
            metavar=</span><span class="s3">'dir'</span><span class="s0">,</span><span class="s1"> 
            default=os.curdir</span><span class="s0">,</span><span class="s1"> 
            help=(</span><span class="s3">&quot;Download packages into &lt;dir&gt;.&quot;</span><span class="s1">)</span><span class="s0">,</span><span class="s1"> 
        ) 
 
        cmd_opts.add_option( 
            </span><span class="s3">'--platform'</span><span class="s0">,</span><span class="s1"> 
            dest=</span><span class="s3">'platform'</span><span class="s0">,</span><span class="s1"> 
            metavar=</span><span class="s3">'platform'</span><span class="s0">,</span><span class="s1"> 
            default=</span><span class="s0">None,</span><span class="s1"> 
            help=(</span><span class="s3">&quot;Only download wheels compatible with &lt;platform&gt;. &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;Defaults to the platform of the running system.&quot;</span><span class="s1">)</span><span class="s0">,</span><span class="s1"> 
        ) 
 
        cmd_opts.add_option( 
            </span><span class="s3">'--python-version'</span><span class="s0">,</span><span class="s1"> 
            dest=</span><span class="s3">'python_version'</span><span class="s0">,</span><span class="s1"> 
            metavar=</span><span class="s3">'python_version'</span><span class="s0">,</span><span class="s1"> 
            default=</span><span class="s0">None,</span><span class="s1"> 
            help=(</span><span class="s3">&quot;Only download wheels compatible with Python &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;interpreter version &lt;version&gt;. If not specified, then the &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;current system interpreter minor version is used. A major &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;version (e.g. '2') can be specified to match all &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;minor revs of that major version.  A minor version &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;(e.g. '34') can also be specified.&quot;</span><span class="s1">)</span><span class="s0">,</span><span class="s1"> 
        ) 
 
        cmd_opts.add_option( 
            </span><span class="s3">'--implementation'</span><span class="s0">,</span><span class="s1"> 
            dest=</span><span class="s3">'implementation'</span><span class="s0">,</span><span class="s1"> 
            metavar=</span><span class="s3">'implementation'</span><span class="s0">,</span><span class="s1"> 
            default=</span><span class="s0">None,</span><span class="s1"> 
            help=(</span><span class="s3">&quot;Only download wheels compatible with Python &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;implementation &lt;implementation&gt;, e.g. 'pp', 'jy', 'cp', &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot; or 'ip'. If not specified, then the current &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;interpreter implementation is used.  Use 'py' to force &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;implementation-agnostic wheels.&quot;</span><span class="s1">)</span><span class="s0">,</span><span class="s1"> 
        ) 
 
        cmd_opts.add_option( 
            </span><span class="s3">'--abi'</span><span class="s0">,</span><span class="s1"> 
            dest=</span><span class="s3">'abi'</span><span class="s0">,</span><span class="s1"> 
            metavar=</span><span class="s3">'abi'</span><span class="s0">,</span><span class="s1"> 
            default=</span><span class="s0">None,</span><span class="s1"> 
            help=(</span><span class="s3">&quot;Only download wheels compatible with Python &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;abi &lt;abi&gt;, e.g. 'pypy_41'.  If not specified, then the &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;current interpreter abi tag is used.  Generally &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;you will need to specify --implementation, &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;--platform, and --python-version when using &quot;</span><span class="s1"> 
                  </span><span class="s3">&quot;this option.&quot;</span><span class="s1">)</span><span class="s0">,</span><span class="s1"> 
        ) 
 
        index_opts = cmdoptions.make_option_group( 
            cmdoptions.non_deprecated_index_group</span><span class="s0">,</span><span class="s1"> 
            self.parser</span><span class="s0">,</span><span class="s1"> 
        ) 
 
        self.parser.insert_option_group(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">index_opts) 
        self.parser.insert_option_group(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">cmd_opts) 
 
    </span><span class="s0">def </span><span class="s1">run(self</span><span class="s0">, </span><span class="s1">options</span><span class="s0">, </span><span class="s1">args): 
        options.ignore_installed = </span><span class="s0">True</span><span class="s1"> 
 
        </span><span class="s0">if </span><span class="s1">options.python_version: 
            python_versions = [options.python_version] 
        </span><span class="s0">else</span><span class="s1">: 
            python_versions = </span><span class="s0">None</span><span class="s1"> 
 
        dist_restriction_set = any([ 
            options.python_version</span><span class="s0">,</span><span class="s1"> 
            options.platform</span><span class="s0">,</span><span class="s1"> 
            options.abi</span><span class="s0">,</span><span class="s1"> 
            options.implementation</span><span class="s0">,</span><span class="s1"> 
        ]) 
        binary_only = FormatControl(set()</span><span class="s0">, </span><span class="s1">set([</span><span class="s3">':all:'</span><span class="s1">])) 
        </span><span class="s0">if </span><span class="s1">dist_restriction_set </span><span class="s0">and </span><span class="s1">options.format_control != binary_only: 
            </span><span class="s0">raise </span><span class="s1">CommandError( 
                </span><span class="s3">&quot;--only-binary=:all: must be set and --no-binary must not &quot;</span><span class="s1"> 
                </span><span class="s3">&quot;be set (or must be set to :none:) when restricting platform &quot;</span><span class="s1"> 
                </span><span class="s3">&quot;and interpreter constraints using --python-version, &quot;</span><span class="s1"> 
                </span><span class="s3">&quot;--platform, --abi, or --implementation.&quot;</span><span class="s1"> 
            ) 
 
        options.src_dir = os.path.abspath(options.src_dir) 
        options.download_dir = normalize_path(options.download_dir) 
 
        ensure_dir(options.download_dir) 
 
        </span><span class="s0">with </span><span class="s1">self._build_session(options) </span><span class="s0">as </span><span class="s1">session: 
            finder = self._build_package_finder( 
                options=options</span><span class="s0">,</span><span class="s1"> 
                session=session</span><span class="s0">,</span><span class="s1"> 
                platform=options.platform</span><span class="s0">,</span><span class="s1"> 
                python_versions=python_versions</span><span class="s0">,</span><span class="s1"> 
                abi=options.abi</span><span class="s0">,</span><span class="s1"> 
                implementation=options.implementation</span><span class="s0">,</span><span class="s1"> 
            ) 
            build_delete = (</span><span class="s0">not </span><span class="s1">(options.no_clean </span><span class="s0">or </span><span class="s1">options.build_dir)) 
            </span><span class="s0">if </span><span class="s1">options.cache_dir </span><span class="s0">and not </span><span class="s1">check_path_owner(options.cache_dir): 
                logger.warning( 
                    </span><span class="s3">&quot;The directory '%s' or its parent directory is not owned &quot;</span><span class="s1"> 
                    </span><span class="s3">&quot;by the current user and caching wheels has been &quot;</span><span class="s1"> 
                    </span><span class="s3">&quot;disabled. check the permissions and owner of that &quot;</span><span class="s1"> 
                    </span><span class="s3">&quot;directory. If executing pip with sudo, you may want &quot;</span><span class="s1"> 
                    </span><span class="s3">&quot;sudo's -H flag.&quot;</span><span class="s0">,</span><span class="s1"> 
                    options.cache_dir</span><span class="s0">,</span><span class="s1"> 
                ) 
                options.cache_dir = </span><span class="s0">None</span><span class="s1"> 
 
            </span><span class="s0">with </span><span class="s1">BuildDirectory(options.build_dir</span><span class="s0">,</span><span class="s1"> 
                                delete=build_delete) </span><span class="s0">as </span><span class="s1">build_dir: 
 
                requirement_set = RequirementSet( 
                    build_dir=build_dir</span><span class="s0">,</span><span class="s1"> 
                    src_dir=options.src_dir</span><span class="s0">,</span><span class="s1"> 
                    download_dir=options.download_dir</span><span class="s0">,</span><span class="s1"> 
                    ignore_installed=</span><span class="s0">True,</span><span class="s1"> 
                    ignore_dependencies=options.ignore_dependencies</span><span class="s0">,</span><span class="s1"> 
                    session=session</span><span class="s0">,</span><span class="s1"> 
                    isolated=options.isolated_mode</span><span class="s0">,</span><span class="s1"> 
                    require_hashes=options.require_hashes 
                ) 
                self.populate_requirement_set( 
                    requirement_set</span><span class="s0">,</span><span class="s1"> 
                    args</span><span class="s0">,</span><span class="s1"> 
                    options</span><span class="s0">,</span><span class="s1"> 
                    finder</span><span class="s0">,</span><span class="s1"> 
                    session</span><span class="s0">,</span><span class="s1"> 
                    self.name</span><span class="s0">,</span><span class="s1"> 
                    </span><span class="s0">None</span><span class="s1"> 
                ) 
 
                </span><span class="s0">if not </span><span class="s1">requirement_set.has_requirements: 
                    </span><span class="s0">return</span><span class="s1"> 
 
                requirement_set.prepare_files(finder) 
 
                downloaded = </span><span class="s3">' '</span><span class="s1">.join([ 
                    req.name </span><span class="s0">for </span><span class="s1">req </span><span class="s0">in </span><span class="s1">requirement_set.successfully_downloaded 
                ]) 
                </span><span class="s0">if </span><span class="s1">downloaded: 
                    logger.info( 
                        </span><span class="s3">'Successfully downloaded %s'</span><span class="s0">, </span><span class="s1">downloaded 
                    ) 
 
                </span><span class="s5"># Clean up</span><span class="s1"> 
                </span><span class="s0">if not </span><span class="s1">options.no_clean: 
                    requirement_set.cleanup_files() 
 
        </span><span class="s0">return </span><span class="s1">requirement_set 
</span></pre>
</body>
</html>