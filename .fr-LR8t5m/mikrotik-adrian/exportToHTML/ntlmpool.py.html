<html>
<head>
<title>ntlmpool.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.ln { color: #606366; font-weight: normal; font-style: normal; }
.s0 { color: rgb(98,151,85); font-style: italic; }
.s1 { color: rgb(169,183,198); }
.s2 { color: rgb(204,120,50); }
.s3 { color: rgb(106,135,89); }
.s4 { color: rgb(104,151,187); }
.s5 { color: rgb(128,128,128); }
</style>
</head>
<BODY BGCOLOR="#2b2b2b">
<TABLE CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<TR><TD><CENTER>
<FONT FACE="Arial, Helvetica" COLOR="#000000">
ntlmpool.py</FONT>
</center></TD></TR></TABLE>
<pre>
<span class="s0">&quot;&quot;&quot; 
NTLM authenticating pool, contributed by erikcederstran 
 
Issue #10, see: http://code.google.com/p/urllib3/issues/detail?id=10 
&quot;&quot;&quot;</span><span class="s1"> 
</span><span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">absolute_import 
 
</span><span class="s2">try</span><span class="s1">: 
    </span><span class="s2">from </span><span class="s1">http.client </span><span class="s2">import </span><span class="s1">HTTPSConnection 
</span><span class="s2">except </span><span class="s1">ImportError: 
    </span><span class="s2">from </span><span class="s1">httplib </span><span class="s2">import </span><span class="s1">HTTPSConnection 
</span><span class="s2">from </span><span class="s1">logging </span><span class="s2">import </span><span class="s1">getLogger 
</span><span class="s2">from </span><span class="s1">ntlm </span><span class="s2">import </span><span class="s1">ntlm 
 
</span><span class="s2">from </span><span class="s1">urllib3 </span><span class="s2">import </span><span class="s1">HTTPSConnectionPool 
 
 
log = getLogger(__name__) 
 
 
</span><span class="s2">class </span><span class="s1">NTLMConnectionPool(HTTPSConnectionPool): 
    </span><span class="s0">&quot;&quot;&quot; 
    Implements an NTLM authentication version of an urllib3 connection pool 
    &quot;&quot;&quot;</span><span class="s1"> 
 
    scheme = </span><span class="s3">'https'</span><span class="s1"> 
 
    </span><span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">user</span><span class="s2">, </span><span class="s1">pw</span><span class="s2">, </span><span class="s1">authurl</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs): 
        </span><span class="s0">&quot;&quot;&quot; 
        authurl is a random URL on the server that is protected by NTLM. 
        user is the Windows user, probably in the DOMAIN\\username format. 
        pw is the password for the user. 
        &quot;&quot;&quot;</span><span class="s1"> 
        super(NTLMConnectionPool</span><span class="s2">, </span><span class="s1">self).__init__(*args</span><span class="s2">, </span><span class="s1">**kwargs) 
        self.authurl = authurl 
        self.rawuser = user 
        user_parts = user.split(</span><span class="s3">'</span><span class="s2">\\</span><span class="s3">'</span><span class="s2">, </span><span class="s4">1</span><span class="s1">) 
        self.domain = user_parts[</span><span class="s4">0</span><span class="s1">].upper() 
        self.user = user_parts[</span><span class="s4">1</span><span class="s1">] 
        self.pw = pw 
 
    </span><span class="s2">def </span><span class="s1">_new_conn(self): 
        </span><span class="s5"># Performs the NTLM handshake that secures the connection. The socket</span><span class="s1"> 
        </span><span class="s5"># must be kept open while requests are performed.</span><span class="s1"> 
        self.num_connections += </span><span class="s4">1</span><span class="s1"> 
        log.debug(</span><span class="s3">'Starting NTLM HTTPS connection no. %d: https://%s%s'</span><span class="s2">,</span><span class="s1"> 
                  self.num_connections</span><span class="s2">, </span><span class="s1">self.host</span><span class="s2">, </span><span class="s1">self.authurl) 
 
        headers = {} 
        headers[</span><span class="s3">'Connection'</span><span class="s1">] = </span><span class="s3">'Keep-Alive'</span><span class="s1"> 
        req_header = </span><span class="s3">'Authorization'</span><span class="s1"> 
        resp_header = </span><span class="s3">'www-authenticate'</span><span class="s1"> 
 
        conn = HTTPSConnection(host=self.host</span><span class="s2">, </span><span class="s1">port=self.port) 
 
        </span><span class="s5"># Send negotiation message</span><span class="s1"> 
        headers[req_header] = ( 
            </span><span class="s3">'NTLM %s' </span><span class="s1">% ntlm.create_NTLM_NEGOTIATE_MESSAGE(self.rawuser)) 
        log.debug(</span><span class="s3">'Request headers: %s'</span><span class="s2">, </span><span class="s1">headers) 
        conn.request(</span><span class="s3">'GET'</span><span class="s2">, </span><span class="s1">self.authurl</span><span class="s2">, None, </span><span class="s1">headers) 
        res = conn.getresponse() 
        reshdr = dict(res.getheaders()) 
        log.debug(</span><span class="s3">'Response status: %s %s'</span><span class="s2">, </span><span class="s1">res.status</span><span class="s2">, </span><span class="s1">res.reason) 
        log.debug(</span><span class="s3">'Response headers: %s'</span><span class="s2">, </span><span class="s1">reshdr) 
        log.debug(</span><span class="s3">'Response data: %s [...]'</span><span class="s2">, </span><span class="s1">res.read(</span><span class="s4">100</span><span class="s1">)) 
 
        </span><span class="s5"># Remove the reference to the socket, so that it can not be closed by</span><span class="s1"> 
        </span><span class="s5"># the response object (we want to keep the socket open)</span><span class="s1"> 
        res.fp = </span><span class="s2">None</span><span class="s1"> 
 
        </span><span class="s5"># Server should respond with a challenge message</span><span class="s1"> 
        auth_header_values = reshdr[resp_header].split(</span><span class="s3">', '</span><span class="s1">) 
        auth_header_value = </span><span class="s2">None</span><span class="s1"> 
        </span><span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">auth_header_values: 
            </span><span class="s2">if </span><span class="s1">s[:</span><span class="s4">5</span><span class="s1">] == </span><span class="s3">'NTLM '</span><span class="s1">: 
                auth_header_value = s[</span><span class="s4">5</span><span class="s1">:] 
        </span><span class="s2">if </span><span class="s1">auth_header_value </span><span class="s2">is None</span><span class="s1">: 
            </span><span class="s2">raise </span><span class="s1">Exception(</span><span class="s3">'Unexpected %s response header: %s' </span><span class="s1">% 
                            (resp_header</span><span class="s2">, </span><span class="s1">reshdr[resp_header])) 
 
        </span><span class="s5"># Send authentication message</span><span class="s1"> 
        ServerChallenge</span><span class="s2">, </span><span class="s1">NegotiateFlags = \ 
            ntlm.parse_NTLM_CHALLENGE_MESSAGE(auth_header_value) 
        auth_msg = ntlm.create_NTLM_AUTHENTICATE_MESSAGE(ServerChallenge</span><span class="s2">,</span><span class="s1"> 
                                                         self.user</span><span class="s2">,</span><span class="s1"> 
                                                         self.domain</span><span class="s2">,</span><span class="s1"> 
                                                         self.pw</span><span class="s2">,</span><span class="s1"> 
                                                         NegotiateFlags) 
        headers[req_header] = </span><span class="s3">'NTLM %s' </span><span class="s1">% auth_msg 
        log.debug(</span><span class="s3">'Request headers: %s'</span><span class="s2">, </span><span class="s1">headers) 
        conn.request(</span><span class="s3">'GET'</span><span class="s2">, </span><span class="s1">self.authurl</span><span class="s2">, None, </span><span class="s1">headers) 
        res = conn.getresponse() 
        log.debug(</span><span class="s3">'Response status: %s %s'</span><span class="s2">, </span><span class="s1">res.status</span><span class="s2">, </span><span class="s1">res.reason) 
        log.debug(</span><span class="s3">'Response headers: %s'</span><span class="s2">, </span><span class="s1">dict(res.getheaders())) 
        log.debug(</span><span class="s3">'Response data: %s [...]'</span><span class="s2">, </span><span class="s1">res.read()[:</span><span class="s4">100</span><span class="s1">]) 
        </span><span class="s2">if </span><span class="s1">res.status != </span><span class="s4">200</span><span class="s1">: 
            </span><span class="s2">if </span><span class="s1">res.status == </span><span class="s4">401</span><span class="s1">: 
                </span><span class="s2">raise </span><span class="s1">Exception(</span><span class="s3">'Server rejected request: wrong '</span><span class="s1"> 
                                </span><span class="s3">'username or password'</span><span class="s1">) 
            </span><span class="s2">raise </span><span class="s1">Exception(</span><span class="s3">'Wrong server response: %s %s' </span><span class="s1">% 
                            (res.status</span><span class="s2">, </span><span class="s1">res.reason)) 
 
        res.fp = </span><span class="s2">None</span><span class="s1"> 
        log.debug(</span><span class="s3">'Connection established'</span><span class="s1">) 
        </span><span class="s2">return </span><span class="s1">conn 
 
    </span><span class="s2">def </span><span class="s1">urlopen(self</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">url</span><span class="s2">, </span><span class="s1">body=</span><span class="s2">None, </span><span class="s1">headers=</span><span class="s2">None, </span><span class="s1">retries=</span><span class="s4">3</span><span class="s2">,</span><span class="s1"> 
                redirect=</span><span class="s2">True, </span><span class="s1">assert_same_host=</span><span class="s2">True</span><span class="s1">): 
        </span><span class="s2">if </span><span class="s1">headers </span><span class="s2">is None</span><span class="s1">: 
            headers = {} 
        headers[</span><span class="s3">'Connection'</span><span class="s1">] = </span><span class="s3">'Keep-Alive'</span><span class="s1"> 
        </span><span class="s2">return </span><span class="s1">super(NTLMConnectionPool</span><span class="s2">, </span><span class="s1">self).urlopen(method</span><span class="s2">, </span><span class="s1">url</span><span class="s2">, </span><span class="s1">body</span><span class="s2">,</span><span class="s1"> 
                                                       headers</span><span class="s2">, </span><span class="s1">retries</span><span class="s2">,</span><span class="s1"> 
                                                       redirect</span><span class="s2">,</span><span class="s1"> 
                                                       assert_same_host) 
</span></pre>
</body>
</html>